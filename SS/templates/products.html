{% extends "navbar.html" %}

{% block title %}Products{% endblock %}

{% block content %}
<div style="margin-top: 100px"></div>

<div class="container">
    <div class="row">
        {% for product in products if product.category != 'Promo' %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="{{ product.product_image }}" 
                         class="card-img-top" 
                         alt="{{ product.product_name }}" 
                         style="object-fit: cover; height: 220px;">

                    <div class="card-body d-flex flex-column justify-content-between text-center">
                        <h5 class="card-title">{{ product.product_name }}</h5>

                        <p class="card-text mb-3">
                            <strong>Price:</strong> ${{ "%.2f"|format(product.price) }}
                        </p>

                        <form method="POST" action="{{ url_for('main.add_to_cart_route') }}" class="d-flex justify-content-center align-items-center gap-3">
                            <input type="hidden" name="product_id" value="{{ product.id }}">

                            <!-- Dropdown with 'of X' label -->
                            <div class="d-flex border rounded overflow-hidden" style="height: 38px;">
                                <select name="quantity" class="form-select border-0" style="width: 60px;">
                                    {% for i in range(1, min(product.quantity, 10) + 1) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <div class="d-flex align-items-center px-2 bg-light border-start">
                                    of {{ product.quantity }}
                                </div>
                            </div>

                            <!-- Add to Cart button -->
                            <button type="button" class="btn ml-2 fw-bold text-white add-to-cart-btn" style="background-color: #3224f0; border: none; border-radius: 10px; padding: 8px 16px;">
                                Add to Cart
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            {% if loop.index % 3 == 0 and not loop.last %}
                </div><div class="row">
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- JavaScript to handle form submission + redirect -->
<script>
    document.querySelectorAll('.add-to-cart-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const form = this.closest('form');
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/cart';
                } else {
                    alert(data.error || 'Failed to add item to cart.');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Error communicating with server.');
            });
        });
    });
</script>

{% endblock content %}
